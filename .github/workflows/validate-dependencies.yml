name: Validate Production Dependencies

on:
  pull_request:
    branches:
      - main
  push:
    branches:
      - main

jobs:
  validate-deps:
    name: Validate Library Versions
    runs-on: ubuntu-latest
    
    steps:
      - name: Checkout code
        uses: actions/checkout@v3
      
      - name: Set up Go
        uses: actions/setup-go@v4
        with:
          go-version: '1.23'
      
      - name: Validate golang-lib version
        run: |
          echo "================================================"
          echo "üîç Validating golang-lib dependency version"
          echo "================================================"
          echo ""
          
          # Extract golang-lib version from go.mod
          LIB_VERSION=$(grep "github.com/bikashb-meesho/golang-lib" go.mod | grep -v "^[[:space:]]*//\|replace" | awk '{print $2}')
          
          if [ -z "$LIB_VERSION" ]; then
            echo "‚ùå ERROR: golang-lib dependency not found in go.mod"
            exit 1
          fi
          
          echo "Found golang-lib version: $LIB_VERSION"
          echo ""
          
          # Check for replace directive
          if grep -qE "^[[:space:]]*replace.*golang-lib" go.mod; then
            echo "‚ùå ERROR: Main branch cannot use 'replace' directive"
            echo ""
            echo "Found replace directive:"
            grep "replace.*golang-lib" go.mod
            echo ""
            echo "Action required:"
            echo "  1. Remove the replace directive"
            echo "  2. Use a production tag: go get github.com/bikashb-meesho/golang-lib@v1.x.x"
            exit 1
          fi
          
          echo "‚úÖ No replace directive found"
          echo ""
          
          # Validate it's a production version (semantic version without pre-release)
          if ! echo "$LIB_VERSION" | grep -qE "^v[0-9]+\.[0-9]+\.[0-9]+$"; then
            echo "‚ùå ERROR: Must use a production semantic version (vX.Y.Z)"
            echo ""
            echo "Current version: $LIB_VERSION"
            echo ""
            if echo "$LIB_VERSION" | grep -qE "-(alpha|beta|rc|dev|pre)"; then
              echo "‚ö†Ô∏è  Pre-release version detected"
              echo ""
              echo "Pre-release versions allowed:"
              echo "  - v1.2.3-alpha    (alpha release)"
              echo "  - v1.2.3-beta.1   (beta release)"
              echo "  - v1.2.3-rc.1     (release candidate)"
              echo "  - v1.2.3-dev.123  (development)"
              echo ""
              echo "But main branch MUST use stable versions:"
              echo "  - v1.2.3          (production ready)"
              echo ""
            elif echo "$LIB_VERSION" | grep -qE "(latest|master|main)"; then
              echo "‚ö†Ô∏è  Branch reference detected: $LIB_VERSION"
              echo ""
              echo "Main branch cannot use branch references."
              echo "Use a tagged version instead."
              echo ""
            else
              echo "Invalid version format: $LIB_VERSION"
            fi
            
            echo "Action required:"
            echo "  1. Find latest stable version:"
            echo "     curl https://api.github.com/repos/bikashb-meesho/golang-lib/tags"
            echo "  2. Update to stable version:"
            echo "     go get github.com/bikashb-meesho/golang-lib@v1.2.3"
            echo "  3. Run: go mod tidy"
            exit 1
          fi
          
          echo "‚úÖ Using production version: $LIB_VERSION"
          echo ""
          
          # Verify the version exists on GitHub
          echo "Verifying version exists on GitHub..."
          if ! git ls-remote --tags https://github.com/bikashb-meesho/golang-lib.git | grep -q "refs/tags/$LIB_VERSION$"; then
            echo "‚ùå ERROR: Version $LIB_VERSION not found in golang-lib repository"
            echo ""
            echo "Available versions:"
            git ls-remote --tags https://github.com/bikashb-meesho/golang-lib.git | grep -E "refs/tags/v[0-9]" | awk '{print $2}' | sed 's|refs/tags/||' | sort -V | tail -10
            exit 1
          fi
          
          echo "‚úÖ Version exists on GitHub"
          echo ""
          
          # Verify the version has an official GitHub Release (created by CI)
          echo "Verifying version has official GitHub Release..."
          RELEASE_CHECK=$(curl -s -H "Accept: application/vnd.github.v3+json" \
            "https://api.github.com/repos/bikashb-meesho/golang-lib/releases/tags/$LIB_VERSION" \
            | grep -E '"tag_name"|"author"')
          
          if echo "$RELEASE_CHECK" | grep -q "tag_name"; then
            # Release exists, check if created by github-actions bot
            if echo "$RELEASE_CHECK" | grep -q "github-actions"; then
              echo "‚úÖ Version has official GitHub Release (created by CI)"
            else
              echo "‚ö†Ô∏è  WARNING: Release exists but not created by CI"
              echo ""
              echo "This version might be manually released."
              echo "Official releases are created by github-actions[bot]"
              exit 1
            fi
          else
            echo "‚ùå ERROR: Version $LIB_VERSION has no GitHub Release"
            echo ""
            echo "Production versions must have an official GitHub Release."
            echo ""
            echo "This usually means:"
            echo "  - Tag was created manually (not by CI)"
            echo "  - Tag was created from a feature branch"
            echo "  - Tag is not an official release"
            echo ""
            echo "Official releases are created automatically when PRs merge to main."
            echo ""
            echo "Available official releases:"
            curl -s "https://api.github.com/repos/bikashb-meesho/golang-lib/releases?per_page=10" \
              | grep -E '"tag_name"' | head -10 | awk -F'"' '{print "  - " $4}'
            echo ""
            echo "Action required:"
            echo "  1. Use an official release version from the list above"
            echo "  2. Or wait for golang-lib PR to merge and create official release"
            exit 1
          fi
          echo ""

          echo "================================================"
          echo "‚úÖ All dependency validations passed!"
          echo "================================================"
          echo ""
          echo "Summary:"
          echo "  Library: github.com/bikashb-meesho/golang-lib"
          echo "  Version: $LIB_VERSION"
          echo "  Status:  Production Ready ‚úÖ"
          echo ""

